<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Enimara - The OS for the Unstructured</title>

  <link rel="icon" type="image/x-icon" href="Enimara Favicon.png">
    
  <!-- Ionic Framework -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
  <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css" />

  <!-- Ionicons -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/ionicons/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://cdn.jsdelivr.net/npm/ionicons/dist/ionicons/ionicons.js"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* --- ENIMARA BRAND THEME --- */
    :root {
      --ion-font-family: 'Noto Sans', sans-serif;
      --ion-color-primary: #0C2340; /* Deep Navy */
      --ion-color-primary-rgb: 12, 35, 64;
      --ion-color-secondary: #F4A42A; /* Warm Gold */
      --ion-color-secondary-rgb: 244, 164, 42;
      
      --app-bg: #F9FAFB;
      --card-bg: #FFFFFF;
      --text-color: #1F2937;
      --text-muted: #6B7280;
      --border-color: #E5E7EB;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      
      --smart-insight-bg: linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%);
      --smart-insight-border: #FCD34D;
      --smart-insight-text: #92400E;
    }

    /* DARK MODE */
    body.dark {
      --ion-color-primary: #476C9B; 
      --ion-color-primary-rgb: 71, 108, 155;
      --ion-color-secondary: #C28E38; 
      --app-bg: #111827;
      --card-bg: #1F2937;
      --text-color: #F3F4F6;
      --text-muted: #9CA3AF;
      --border-color: #374151;
      --smart-insight-bg: linear-gradient(135deg, #374151 0%, #1F2937 100%);
      --smart-insight-border: #4B5563;
      --smart-insight-text: #F3F4F6;
    }

    body { 
      font-family: 'Noto Sans', sans-serif; 
      background-color: var(--app-bg);
      color: var(--text-color);
      margin: 0; overflow: hidden;
      transition: background-color 0.3s;
    }

    /* UTILITIES */
    .text-primary { color: var(--ion-color-primary); }
    .text-secondary { color: var(--ion-color-secondary); }
    .text-success { color: #10B981; }
    .text-danger { color: #EF4444; }
    .text-gray { color: var(--text-muted); }
    .font-bold { font-weight: 700; }
    .text-sm { font-size: 0.875rem; }
    .text-xs { font-size: 0.75rem; }
    .hidden { display: none !important; }
    .ion-activatable { position: relative; overflow: hidden; cursor: pointer; }

    /* LAYOUT */
    .page-container {
      width: 100%; height: 100%; position: absolute; top: 0; left: 0;
      background: var(--app-bg); overflow-y: auto; z-index: 10;
      padding-bottom: 90px;
    }

    .app-card {
      background: var(--card-bg); border-radius: 16px; padding: 16px;
      box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);
      margin-bottom: 16px; position: relative;
    }

    .custom-input {
      background: var(--card-bg); border: 1px solid var(--border-color);
      border-radius: 12px; padding: 12px 16px; margin-bottom: 16px;
      display: flex; align-items: center;
    }
    .custom-input input, .custom-input select, .custom-input textarea {
      border: none; outline: none; width: 100%; background: transparent;
      color: var(--text-color); font-family: inherit; font-size: 16px;
    }

    /* OFFLINE BANNER */
    #offline-banner {
      background: #374151; color: white; text-align: center;
      padding: 10px; font-size: 12px; font-weight: 600;
      position: sticky; top: 0; z-index: 1000;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }

    /* TAB BAR */
    .custom-tab-bar {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--card-bg); border-top: 1px solid var(--border-color);
      height: 70px; display: flex; justify-content: space-between;
      align-items: center; padding: 0 10px; z-index: 100;
      padding-bottom: env(safe-area-inset-bottom);
      box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.05);
    }
    .tab-btn {
      flex: 1; display: flex; flex-direction: column; align-items: center;
      color: var(--text-muted); font-size: 10px; background: none;
      border: none; padding: 8px 0; transition: color 0.2s;
    }
    .tab-btn.active { color: var(--ion-color-secondary); font-weight: 600; }
    .tab-btn ion-icon { font-size: 24px; margin-bottom: 4px; }

    /* CHARTS */
    .chart-container { margin: 20px 0; overflow: hidden; }
    .svg-chart { width: 100%; height: 180px; overflow: visible; }
    .chart-grid-line { stroke: var(--border-color); stroke-width: 1; stroke-dasharray: 4 4; opacity: 0.5; }
    .chart-axis-text { font-size: 10px; fill: var(--text-muted); }
    .chart-bar { fill: var(--ion-color-secondary); rx: 4; transition: height 0.3s ease; }

    /* STOCK TABS */
    .stock-tab {
        padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600;
        background: var(--card-bg); color: var(--text-muted);
        border: 1px solid var(--border-color); cursor: pointer; white-space: nowrap;
        transition: all 0.2s;
    }
    .stock-tab.active {
        background: var(--ion-color-primary); color: white; border-color: var(--ion-color-primary);
    }

    /* CUSTOMER CARDS */
    .customer-card {
        background: var(--card-bg); border: 1px solid var(--border-color);
        border-radius: 12px; padding: 12px; margin-bottom: 10px;
        display: flex; justify-content: space-between; align-items: center;
    }
    .debt-badge {
        background: #FEE2E2; color: #B91C1C; font-size: 11px;
        padding: 4px 8px; border-radius: 12px; font-weight: 700;
    }
    .top-customer-item {
        min-width: 110px; text-align: center; margin-right: 12px;
        background: var(--card-bg); padding: 12px; border-radius: 12px;
        border: 1px solid var(--border-color);
        position: relative; overflow: hidden;
    }

    /* AI SUGGESTIONS */
    .ai-card {
        background: var(--smart-insight-bg);
        border: 1px solid var(--smart-insight-border);
        border-radius: 16px; padding: 16px; margin-bottom: 20px;
    }
    .ai-action-btn {
        background: var(--ion-color-secondary); color: black; font-size: 11px; padding: 6px 12px;
        border-radius: 12px; font-weight: 600; display: inline-block; margin-top: 8px;
    }

    /* LIST ITEMS & RIPPLES */
    .list-item {
        padding: 16px; border-bottom: 1px solid var(--border-color);
        display: flex; align-items: center; justify-content: space-between;
        position: relative; overflow: hidden;
    }
    .list-item:last-child { border-bottom: none; }

    /* BUTTONS */
    .btn-gold {
        --background: var(--ion-color-secondary);
        --color: #000;
        font-weight: 700;
        --border-radius: 12px;
        margin: 0;
    }
    .add-cat-btn {
        background: var(--ion-color-primary); color: white;
        width: 44px; height: 44px; border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        box-shadow: var(--shadow-md);
    }

    /* MODALS */
    .fullscreen-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--app-bg); z-index: 300; overflow-y: auto;
      display: flex; flex-direction: column;
    }
    .popup-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 10000;
        display: flex; justify-content: center; align-items: center; padding: 20px;
    }
    .popup-content {
        background: var(--card-bg);
        border-radius: 20px; padding: 24px;
        width: 100%; max-width: 340px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        max-height: 80vh; overflow-y: auto;
    }

    /* INVOICE */
    .invoice-paper {
        background: #fff; color: #000; padding: 20px;
        font-family: 'Courier New', monospace;
        border-radius: 4px; border: 1px solid #ddd;
        margin-bottom: 16px;
    }
    .invoice-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px; }
    .invoice-divider { border-bottom: 1px dashed #000; margin: 10px 0; }
  </style>
</head>
<body id="app-body">
  <ion-app>

    <!-- OFFLINE INDICATOR -->
    <div id="offline-banner" class="hidden">
      <ion-icon name="cloud-offline"></ion-icon>
      <span>Network is causing go-slow. Don't worry, keep selling! We will sync when it's back.</span>
    </div>
    
    <!-- ================== 1. LOGIN PAGE ================== -->
    <div id="page-login" class="page-container" style="z-index: 500; display: flex; flex-direction: column; justify-content: center; padding: 24px;">
      <div style="text-align: center; margin-bottom: 40px;">
        <img src="Enimara Favicon.png" alt="Logo" style="width: 80px; height: 80px; border-radius: 20px; box-shadow: var(--shadow-md);">
        <h1 class="text-primary font-bold" style="margin-top: 16px; font-size: 28px;">Enimara</h1>
        <p class="text-gray">Manage your business like a Boss</p>
      </div>

      <div class="custom-input">
        <input type="email" value="oreoluwa@store.com" placeholder="Email Address">
      </div>
      <div class="custom-input">
        <input type="password" value="password" placeholder="Password">
        <ion-icon name="eye-outline" class="text-gray"></ion-icon>
      </div>

      <ion-button expand="block" class="btn-gold" style="margin-top: 24px;" onclick="navigateTo('page-dashboard')">Sign In</ion-button>
    </div>


    <!-- ================== 2. DASHBOARD ================== -->
    <div id="page-dashboard" class="page-container hidden">
      
      <!-- TAB 1: HOME -->
      <div id="tab-home" class="tab-content">
        <div class="ion-padding">
          <!-- Header -->
          <div style="display: flex; align-items: center; margin-bottom: 24px;">
            <div style="width: 50px; height: 50px; border-radius: 50%; background: #f0f0f0; overflow: hidden; margin-right: 12px; border: 2px solid var(--ion-color-secondary);">
              <img src="oluwaferanmi-caleb-Q1QRTSeZIxI-unsplash (1).jpg" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            <div>
              <div class="text-xs text-gray">Welcome back,</div>
              <div class="font-bold text-lg text-primary">Oreoluwa Store</div>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; margin-left: auto;">
               <div id="status-badge" style="background: #D1FAE5; color: #065F46; border-radius: 20px; padding: 4px 12px; font-size: 11px; font-weight: 700; transition: all 0.3s;">Online</div>
               <div style="position: relative;">
                 <ion-icon name="notifications-outline" style="font-size: 24px; color: var(--text-color);"></ion-icon>
                 <span style="position: absolute; top: -2px; right: -2px; background: red; color: white; border-radius: 50%; width: 14px; height: 14px; font-size: 9px; display: flex; align-items: center; justify-content: center;">3</span>
               </div>
            </div>
          </div>

          <!-- Dynamic Smart Insights -->
          <div class="ai-card">
              <div style="display: flex; gap: 10px; align-items: flex-start;">
                  <ion-icon name="bulb" style="color: var(--ion-color-secondary); font-size: 24px;"></ion-icon>
                  <div>
                      <div class="font-bold text-sm" style="color: var(--smart-insight-text);">Smart Insight</div>
                      <div class="text-xs" style="color: var(--smart-insight-text); margin-top: 4px;" id="home-insight-text">Loading insights...</div>
                      <div class="ai-action-btn" id="home-insight-btn" onclick="switchTab('inventory')">Check Stock</div>
                  </div>
              </div>
          </div>

          <!-- Key Metrics -->
          <div style="display: flex; gap: 12px; margin-bottom: 24px;">
            <div class="app-card ion-activatable" style="flex: 1; margin-bottom: 0; background: var(--ion-color-primary); color: white; border: none;" onclick="openModal('page-todays-sales')">
              <ion-ripple-effect></ion-ripple-effect>
              <div style="display: flex; justify-content: space-between;">
                <span class="text-xs" style="opacity: 0.8;">Today's Sales</span>
                <ion-icon name="chevron-forward" style="opacity: 0.6;"></ion-icon>
              </div>
              <div class="font-bold text-xl" style="margin-top: 8px;" id="home-today-sales">â‚¦ 0</div>
            </div>
            <div class="app-card ion-activatable" style="flex: 1; margin-bottom: 0;">
               <ion-ripple-effect></ion-ripple-effect>
               <div style="display: flex; justify-content: space-between;">
                <span class="text-xs text-gray">Low Stock</span>
                <ion-icon name="alert-circle" class="text-danger"></ion-icon>
              </div>
              <div class="font-bold text-xl" style="margin-top: 8px;">5 <span class="text-xs text-gray font-normal">items</span></div>
            </div>
          </div>

          <!-- Detailed Charts (Nigerian Context) -->
          <div class="app-card">
            <h3 class="font-bold text-sm" style="margin-bottom: 4px;">Market Reach (Last 5 Months)</h3>
            <p class="text-xs text-gray" style="margin-bottom: 12px;">How your shop is growing</p>
            <div id="bar-chart-container" class="chart-container"></div>
            
            <div style="height: 1px; background: var(--border-color); margin: 24px 0;"></div>
            
            <h3 class="font-bold text-sm" style="margin-bottom: 4px;">Customer Retention</h3>
            <p class="text-xs text-gray" style="margin-bottom: 12px;">Returning Customers vs New Faces</p>
            <div id="line-chart-container" class="chart-container"></div>
          </div>

          <!-- Recent Activity -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
             <h3 class="font-bold text-sm">Recent Activity</h3>
             <span class="text-xs text-secondary font-bold" onclick="openModal('page-activity-all')" style="cursor: pointer;">See all</span>
          </div>
          <div class="app-card" style="padding: 0;" id="recent-activity-list"></div>
        </div>
      </div>

      <!-- TAB 2: POS -->
      <div id="tab-pos" class="tab-content hidden">
        <div class="ion-padding">
          <!-- Dynamic Insight -->
          <div class="ai-card" style="margin-bottom: 16px; padding: 12px;">
             <div class="text-xs" style="color: var(--smart-insight-text);">ðŸ’¡ <b>Tip:</b> Most customers ask for receipts around 4PM. Be ready!</div>
          </div>

          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h2 class="font-bold text-lg text-primary">Point of Sale</h2>
            <ion-icon id="pos-status-icon" name="cloud-done" style="font-size: 24px; color: var(--ion-color-secondary);"></ion-icon>
          </div>
          
          <div style="display: flex; gap: 12px; margin-bottom: 24px;">
            <div class="custom-input" style="flex: 1; margin-bottom: 0;">
              <ion-icon name="search-outline" style="margin-right: 8px; color: #999;"></ion-icon>
              <input placeholder="Search product to add..." readonly onclick="openModal('page-pos-add-item')">
              <ion-icon name="add-circle" style="margin-left: 8px; font-size: 24px; color: var(--ion-color-secondary);"></ion-icon>
            </div>
          </div>

          <!-- Empty State -->
          <div id="pos-empty" style="text-align: center; margin-top: 60px;">
            <div style="width: 120px; height: 120px; background: var(--card-bg); border: 1px dashed var(--border-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px auto;">
                <ion-icon name="basket-outline" style="font-size: 64px; color: var(--text-muted);"></ion-icon>
            </div>
            <p class="text-gray">Cart is empty.</p>
            <p class="text-xs text-gray">Click search or scan to start selling.</p>
            <ion-button fill="outline" class="btn-gold" style="margin-top: 20px; color: black;" onclick="openModal('page-pos-add-item')">Add Products</ion-button>
          </div>

          <!-- Active Cart -->
          <div id="pos-active" class="hidden" style="padding-bottom: 100px;">
             <div class="app-card">
               <div id="pos-items-list"></div>
               <div style="border-top: 1px dashed var(--border-color); padding-top: 16px; margin-top: 16px;">
                 <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="font-bold text-lg">Total</span>
                    <span class="font-bold text-2xl text-primary" id="pos-total">â‚¦ 0</span>
                 </div>
               </div>
             </div>
             <ion-button expand="block" class="btn-gold" onclick="openInvoicePreview()">
                Generate Invoice <ion-icon slot="end" name="receipt-outline"></ion-icon>
             </ion-button>
          </div>
        </div>
      </div>

      <!-- TAB 3: INVENTORY -->
      <div id="tab-inventory" class="tab-content hidden">
        <div class="ion-padding">
           <!-- Dynamic Insight -->
           <div class="ai-card" style="margin-bottom: 16px; padding: 12px;">
             <div class="text-xs" style="color: var(--smart-insight-text);">ðŸ’¡ <b>Insight:</b> <b>Malta Guinness</b> stock is low. Consider restocking for the weekend rush.</div>
           </div>

           <h2 class="font-bold text-lg text-primary" style="margin-bottom: 16px;">Stock Level</h2>
           <div class="custom-input">
             <ion-icon name="search-outline" style="margin-right: 8px;"></ion-icon>
             <input placeholder="Find product..." id="inventory-search" oninput="renderInventoryList()">
           </div>
           
           <!-- Dynamic Categories -->
           <div style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; margin-bottom: 16px; scrollbar-width: none;" id="inventory-category-tabs">
             <!-- Populated by JS -->
           </div>

           <div id="inventory-list" style="padding-bottom: 80px;"></div>
        </div>
        
        <!-- FAB -->
        <div style="position: fixed; bottom: 85px; right: 20px; z-index: 200;">
          <ion-fab-button color="secondary" onclick="openModal('page-add-product')">
            <ion-icon name="add"></ion-icon>
          </ion-fab-button>
        </div>
      </div>

      <!-- TAB 4: CUSTOMERS -->
      <div id="tab-customers" class="tab-content hidden">
        <div class="ion-padding">
           <!-- Dynamic Insight -->
           <div class="ai-card" style="margin-bottom: 16px; padding: 12px;">
             <div class="text-xs" style="color: var(--smart-insight-text);">ðŸ’¡ <b>Tip:</b> Call your top debtors on Fridays. Recovery rate is higher.</div>
           </div>

           <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
             <h2 class="font-bold text-lg text-primary">Customers</h2>
             <div class="ion-activatable" style="background: var(--ion-color-secondary); color: black; width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-md);" onclick="openModal('page-add-customer')">
                 <ion-ripple-effect></ion-ripple-effect>
                 <ion-icon name="person-add" style="font-size: 20px;"></ion-icon>
             </div>
           </div>

           <!-- Top Customers Section -->
           <h3 class="font-bold text-sm" style="margin-bottom: 12px;">Top Customers (All Time)</h3>
           <div style="display: flex; overflow-x: auto; padding-bottom: 16px; margin-bottom: 8px; scrollbar-width: none;" id="top-customers-list"></div>

           <h3 class="font-bold text-sm" style="margin-bottom: 12px;">Top Customers (This Month)</h3>
           <div style="display: flex; overflow-x: auto; padding-bottom: 16px; margin-bottom: 8px; scrollbar-width: none;" id="top-customers-month-list"></div>

           <!-- Filter Segments -->
           <div style="display: flex; background: var(--border-color); padding: 4px; border-radius: 12px; margin-bottom: 16px;">
               <div id="seg-all" class="text-xs font-bold" style="flex: 1; text-align: center; padding: 10px; background: var(--card-bg); border-radius: 10px; box-shadow: var(--shadow-sm); transition: all 0.2s;" onclick="filterCustomers('all')">All Customers</div>
               <div id="seg-owing" class="text-xs font-bold text-gray" style="flex: 1; text-align: center; padding: 10px; transition: all 0.2s;" onclick="filterCustomers('owing')">Debtors List</div>
           </div>

           <div class="custom-input">
             <ion-icon name="search-outline" style="margin-right: 8px;"></ion-icon>
             <input placeholder="Search name or phone..." id="customer-search" oninput="renderCustomerList()">
           </div>

           <div id="customer-list-container"></div>
        </div>
      </div>

      <!-- TAB 5: SETTINGS -->
      <div id="tab-settings" class="tab-content hidden">
        <div class="ion-padding">
           <h2 class="font-bold text-lg text-primary" style="margin-bottom: 20px;">Settings</h2>
           
           <div class="app-card" style="padding: 0;">
             <div class="list-item ion-activatable" onclick="openModal('page-profile')">
               <ion-ripple-effect></ion-ripple-effect>
               <div style="display: flex; align-items: center;">
                 <div style="background: var(--app-bg); padding: 8px; border-radius: 8px; margin-right: 12px;">
                    <ion-icon name="storefront" style="font-size: 20px; color: var(--ion-color-primary);"></ion-icon>
                 </div>
                 <span>Shop Profile</span>
               </div>
               <ion-icon name="chevron-forward" class="text-gray"></ion-icon>
             </div>
             
             <div class="list-item ion-activatable" onclick="openModal('page-staff')">
               <ion-ripple-effect></ion-ripple-effect>
               <div style="display: flex; align-items: center;">
                 <div style="background: var(--app-bg); padding: 8px; border-radius: 8px; margin-right: 12px;">
                    <ion-icon name="people" style="font-size: 20px; color: var(--ion-color-primary);"></ion-icon>
                 </div>
                 <span>Staff Management</span>
               </div>
               <ion-icon name="chevron-forward" class="text-gray"></ion-icon>
             </div>

             <div class="list-item">
               <div style="display: flex; align-items: center;">
                 <div style="background: var(--app-bg); padding: 8px; border-radius: 8px; margin-right: 12px;">
                    <ion-icon name="moon" style="font-size: 20px; color: var(--ion-color-primary);"></ion-icon>
                 </div>
                 <span>Dark Mode</span>
               </div>
               <ion-toggle id="theme-toggle" onionchange="toggleTheme()"></ion-toggle>
             </div>
           </div>

           <ion-button expand="block" fill="outline" color="danger" style="margin-top: 30px;" onclick="navigateTo('page-login')">
             Log Out
           </ion-button>
           
           <div style="text-align: center; margin-top: 20px;">
               <p class="text-xs text-gray">Enimara v1.3.0 (Demo Edition)</p>
           </div>
        </div>
      </div>


      <!-- CUSTOM BOTTOM TAB BAR -->
      <div class="custom-tab-bar">
        <button class="tab-btn active" onclick="switchTab('home')" id="btn-home">
          <ion-icon name="home-outline"></ion-icon>
          Home
        </button>
        <button class="tab-btn" onclick="switchTab('pos')" id="btn-pos">
          <ion-icon name="calculator-outline"></ion-icon>
          POS
        </button>
        <button class="tab-btn" onclick="switchTab('inventory')" id="btn-inventory">
          <ion-icon name="cube-outline"></ion-icon>
          Stock
        </button>
        <button class="tab-btn" onclick="switchTab('customers')" id="btn-customers">
          <ion-icon name="people-outline"></ion-icon>
          Customers
        </button>
        <button class="tab-btn" onclick="switchTab('settings')" id="btn-settings">
          <ion-icon name="settings-outline"></ion-icon>
          Settings
        </button>
      </div>

    </div>

    <!-- ================== MODALS ================== -->

    <!-- INVOICE PREVIEW MODAL -->
    <div id="page-invoice-preview" class="fullscreen-modal hidden" style="z-index: 2000;">
        <div class="ion-padding">
            <div style="display: flex; align-items: center; margin-bottom: 16px;">
               <ion-icon name="arrow-back" style="font-size: 24px; margin-right: 10px;" onclick="closeModal('page-invoice-preview')"></ion-icon>
               <h2 class="font-bold text-lg">Invoice Preview</h2>
            </div>
            
            <div class="invoice-paper" id="invoice-content">
                <div style="text-align: center; margin-bottom: 10px;">
                    <div style="font-weight: bold; font-size: 16px;" id="inv-shop-name">OREOLUWA STORE</div>
                    <div style="font-size: 11px;" id="inv-shop-address">12 Market Road, Lagos</div>
                    <div style="font-size: 11px;">Tel: <span id="inv-shop-phone">08012345678</span></div>
                </div>
                <div class="invoice-divider"></div>
                <div class="invoice-row">
                    <span>Date: <span id="inv-date"></span></span>
                    <span>Time: <span id="inv-time"></span></span>
                </div>
                <div class="invoice-divider"></div>
                <div id="inv-items"></div>
                <div class="invoice-divider"></div>
                <div class="invoice-row" style="font-weight: bold; font-size: 16px;">
                    <span>TOTAL</span>
                    <span id="inv-total">â‚¦0.00</span>
                </div>
                <div class="invoice-divider"></div>
                <div style="text-align: center; font-size: 11px; margin-top: 10px;">
                    Thanks for your patronage!<br>No Refund after payment.
                </div>
            </div>

            <ion-button expand="block" class="btn-gold" onclick="finalizeSale()">Confirm & Print</ion-button>
        </div>
    </div>

    <!-- ADD PRODUCT MODAL -->
    <div id="page-add-product" class="fullscreen-modal hidden">
       <div class="ion-padding">
         <div style="display: flex; align-items: center; margin-bottom: 24px;">
           <ion-icon name="arrow-back" style="font-size: 24px; margin-right: 10px;" onclick="closeModal('page-add-product')"></ion-icon>
           <h2 class="font-bold text-lg">Add New Product</h2>
         </div>
         <div class="app-card">
            <label class="text-xs font-bold text-gray">Product Name</label>
            <div class="custom-input"><input type="text" id="add-prod-name" placeholder="e.g., Malta Guinness"></div>
            
            <label class="text-xs font-bold text-gray">Category</label>
            <div class="custom-input" style="gap: 8px;">
                <select id="add-prod-category" style="flex: 1;">
                    <!-- Filled by JS -->
                </select>
                <!-- Loud Add Category Button -->
                <div class="add-cat-btn ion-activatable" onclick="promptAddCategory()">
                    <ion-ripple-effect></ion-ripple-effect>
                    <ion-icon name="add" style="font-size: 24px; font-weight: bold;"></ion-icon>
                </div>
            </div>

            <label class="text-xs font-bold text-gray">Selling Price (â‚¦)</label>
            <div class="custom-input"><input type="number" id="add-prod-price" placeholder="0.00"></div>
            
            <label class="text-xs font-bold text-gray">Initial Stock</label>
            <div class="custom-input"><input type="number" id="add-prod-stock" placeholder="0"></div>
         </div>
         <ion-button expand="block" class="btn-gold" onclick="saveNewProduct()">Save Product</ion-button>
       </div>
    </div>

    <!-- PRODUCT DETAILS / EDIT / RESTOCK MODAL -->
    <div id="page-product-details" class="fullscreen-modal hidden">
       <div class="ion-padding">
         <div style="display: flex; align-items: center; margin-bottom: 24px;">
           <ion-icon name="arrow-back" style="font-size: 24px; margin-right: 10px;" onclick="closeModal('page-product-details')"></ion-icon>
           <h2 class="font-bold text-lg">Product Details</h2>
         </div>
         
         <div class="app-card" style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 40px; color: var(--ion-color-primary);"><ion-icon name="cube"></ion-icon></div>
            <h2 class="font-bold text-xl" id="edit-prod-title">Product Name</h2>
            <p class="text-sm text-gray" id="edit-prod-sku">SKU: 123</p>
         </div>

         <div class="app-card">
            <label class="text-xs font-bold text-gray">Current Stock</label>
            <div style="display: flex; gap: 10px; margin-bottom: 16px;">
                <div class="custom-input" style="flex: 1; margin-bottom: 0;">
                    <input type="number" id="edit-prod-stock" readonly>
                </div>
                <ion-button color="success" style="margin: 0; width: 100px;" onclick="restockProduct()">
                    + Restock
                </ion-button>
            </div>
            
            <label class="text-xs font-bold text-gray">Selling Price (â‚¦)</label>
            <div class="custom-input"><input type="number" id="edit-prod-price"></div>
         </div>
         
         <ion-button expand="block" class="btn-gold" style="margin-bottom: 12px;" onclick="saveProductEdits()">Save Changes</ion-button>
         <ion-button expand="block" fill="outline" color="danger" onclick="deleteProduct()">Delete Product</ion-button>
       </div>
    </div>

    <!-- CUSTOMER DETAILS MODAL (Enhanced) -->
    <div id="page-customer-details" class="fullscreen-modal hidden">
        <div class="ion-padding">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <ion-icon name="arrow-back" style="font-size: 24px;" onclick="closeModal('page-customer-details')"></ion-icon>
                <div class="text-primary font-bold">Customer Details</div>
                <ion-icon name="create-outline" style="font-size: 24px;" onclick="showToast('Edit feature coming soon')"></ion-icon>
            </div>
            
            <div class="app-card" style="text-align: center; padding: 30px 16px; background: linear-gradient(135deg, var(--ion-color-primary) 0%, #1a3c66 100%); color: white;">
                <div style="width: 70px; height: 70px; background: rgba(255,255,255,0.2); border-radius: 50%; margin: 0 auto 12px auto; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: bold;">
                    <span id="detail-cust-initial">J</span>
                </div>
                <div style="font-size: 22px; font-weight: 700;" id="detail-cust-name">John Doe</div>
                <div style="opacity: 0.8;" id="detail-cust-phone">08012345678</div>
                
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 12px;">
                        <div style="font-size: 10px; opacity: 0.8;">TOTAL SPENT</div>
                        <div style="font-weight: bold;" id="detail-cust-spent">â‚¦0</div>
                    </div>
                     <div style="background: white; color: var(--ion-color-primary); padding: 8px 16px; border-radius: 12px;">
                        <div style="font-size: 10px; opacity: 0.8;">DEBT</div>
                        <div style="font-weight: bold;" id="detail-cust-balance">â‚¦0</div>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 12px; margin: 16px 0;">
                <ion-button expand="block" style="flex: 1;" color="success" onclick="showToast('Call feature simulated')">
                    <ion-icon slot="start" name="call"></ion-icon> Call
                </ion-button>
                <!-- Changed SMS color from danger to medium/tertiary per request -->
                <ion-button expand="block" style="flex: 1;" color="medium" onclick="showToast('SMS feature simulated')">
                    <ion-icon slot="start" name="chatbubble"></ion-icon> SMS
                </ion-button>
            </div>

            <h3 class="font-bold text-sm" style="margin-top: 12px;">Transaction History</h3>
            <div class="app-card" id="detail-cust-history" style="min-height: 100px;">
                <!-- Populated by JS -->
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                 <ion-button expand="block" fill="outline" color="primary" style="flex: 1;" onclick="openModal('page-record-payment')">Record Payment</ion-button>
                 <ion-button expand="block" fill="outline" color="warning" style="flex: 1;" onclick="openModal('page-generate-reminder')">Remind</ion-button>
            </div>

            <!-- DELETE CUSTOMER BUTTON -->
            <ion-button expand="block" fill="clear" color="danger" style="margin-top: 20px;" onclick="deleteCustomer()">
                <ion-icon slot="start" name="trash"></ion-icon> Delete Customer
            </ion-button>
        </div>
    </div>

    <!-- RECORD DEBT PAYMENT MODAL -->
    <div id="page-record-payment" class="popup-modal hidden">
        <div class="popup-content">
            <h3 class="font-bold text-lg" style="margin-bottom: 16px;">Record Payment</h3>
            <p class="text-sm text-gray" style="margin-bottom: 12px;">How much did the customer pay?</p>
            <div class="custom-input">
                <span style="font-weight: bold; margin-right: 5px;">â‚¦</span>
                <input type="number" id="debt-payment-amount" placeholder="0.00">
            </div>
            <ion-button expand="block" class="btn-gold" onclick="confirmDebtPayment()">Confirm Payment</ion-button>
            <ion-button expand="block" fill="clear" color="medium" onclick="closeModal('page-record-payment')">Cancel</ion-button>
        </div>
    </div>

    <!-- GENERATE REMINDER MODAL -->
    <div id="page-generate-reminder" class="popup-modal hidden">
        <div class="popup-content">
             <h3 class="font-bold text-lg" style="margin-bottom: 16px;">Send Reminder</h3>
             <label class="text-xs font-bold text-gray">Expected Payment Date</label>
             <div class="custom-input"><input type="date" id="reminder-date"></div>
             
             <label class="text-xs font-bold text-gray">Preview Message</label>
             <div class="app-card" style="background: #e5e7eb; padding: 10px; font-size: 12px; margin-bottom: 16px;" id="reminder-preview">
                 Hello, kindly pay your debt of N5,000 to Oreoluwa Store by [Date]. Thanks.
             </div>
             
             <ion-button expand="block" color="success" onclick="shareReminder()">
                 <ion-icon slot="start" name="logo-whatsapp"></ion-icon> Send via WhatsApp
             </ion-button>
             <ion-button expand="block" fill="clear" color="medium" onclick="closeModal('page-generate-reminder')">Cancel</ion-button>
        </div>
    </div>

    <!-- POS ITEM MODAL (Fixed) -->
    <div id="page-pos-add-item" class="popup-modal hidden">
        <div class="popup-content">
            <h3 class="font-bold text-lg" style="margin-bottom: 16px;">Select Item</h3>
             <div class="custom-input" style="padding: 8px; margin-bottom: 12px;">
              <ion-icon name="search-outline"></ion-icon>
              <input placeholder="Filter..." id="pos-filter-input" oninput="renderPosAddList()">
            </div>
            <div id="pos-add-list" style="max-height: 300px; overflow-y: auto;"></div>
            <ion-button expand="block" fill="clear" color="medium" onclick="closeModal('page-pos-add-item')">Cancel</ion-button>
        </div>
    </div>

    <!-- QUANTITY MODAL -->
    <div id="page-pos-qty" class="popup-modal hidden">
        <div class="popup-content" style="text-align: center;">
            <h3 class="font-bold text-lg" id="qty-item-name">Item Name</h3>
            <p class="text-xs text-gray" id="qty-stock-display">Stock: 0</p>
            
            <div style="display: flex; align-items: center; justify-content: center; gap: 16px; margin: 24px 0;">
                <div onclick="adjustQty(-1)" style="width: 40px; height: 40px; background: var(--border-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px;">-</div>
                <input type="number" id="qty-input" value="1" style="width: 60px; text-align: center; font-size: 24px; border: none; background: transparent; font-weight: bold;">
                <div onclick="adjustQty(1)" style="width: 40px; height: 40px; background: var(--ion-color-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px;">+</div>
            </div>
            
            <ion-button expand="block" class="btn-gold" onclick="confirmAddToCart()">Add to Cart</ion-button>
        </div>
    </div>

    <!-- Other Modals (Retained) -->
    <div id="page-todays-sales" class="fullscreen-modal hidden">
        <div class="ion-padding">
            <div style="display: flex; align-items: center; margin-bottom: 24px;">
               <ion-icon name="arrow-back" style="font-size: 24px; margin-right: 10px;" onclick="closeModal('page-todays-sales')"></ion-icon>
               <h2 class="font-bold text-lg">Today's Sales</h2>
            </div>
            <div class="app-card" style="text-align: center; background: var(--ion-color-primary); color: white;">
                <div class="text-xs" style="opacity: 0.8;">Total Revenue</div>
                <div class="font-bold text-3xl" style="margin-top: 4px;" id="modal-sales-total">â‚¦ 0</div>
            </div>
            <h3 class="font-bold text-sm" style="margin-bottom: 12px;">Transactions</h3>
            <div id="todays-sales-list"></div>
        </div>
    </div>

    <div id="page-activity-all" class="fullscreen-modal hidden">
        <div class="ion-padding">
            <div style="display: flex; align-items: center; margin-bottom: 24px;">
               <ion-icon name="arrow-back" style="font-size: 24px; margin-right: 10px;" onclick="closeModal('page-activity-all')"></ion-icon>
               <h2 class="font-bold text-lg">All Activity</h2>
            </div>
            <div id="all-activity-list-content"></div>
        </div>
    </div>

    <!-- PROFILE PAGE -->
    <div id="page-profile" class="fullscreen-modal hidden">
        <div class="ion-padding">
            <div style="display: flex; align-items: center; margin-bottom: 24px;">
               <ion-icon name="arrow-back" style="font-size: 24px; margin-right: 10px;" onclick="closeModal('page-profile')"></ion-icon>
               <h2 class="font-bold text-lg">Shop Profile</h2>
            </div>
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="width: 80px; height: 80px; background: #ddd; border-radius: 50%; margin: 0 auto; overflow: hidden; border: 3px solid white; box-shadow: var(--shadow-md);">
                    <img src="oluwaferanmi-caleb-Q1QRTSeZIxI-unsplash (1).jpg" style="width:100%; height:100%; object-fit:cover;">
                </div>
                <div class="text-primary font-bold" style="margin-top: 8px;">Oreoluwa Store</div>
                <div class="text-gray text-xs">ID: SHOP-8821</div>
            </div>
            <div class="app-card">
                <label class="text-xs font-bold text-gray">Shop Name</label>
                <div class="custom-input"><input type="text" id="prof-name" value="Oreoluwa Store"></div>
                <label class="text-xs font-bold text-gray">Phone</label>
                <div class="custom-input"><input type="tel" id="prof-phone" value="08012345678"></div>
                <label class="text-xs font-bold text-gray">Address</label>
                <div class="custom-input"><input type="text" id="prof-addr" value="12 Market Road, Lagos"></div>
            </div>
            <ion-button expand="block" class="btn-gold" onclick="saveProfile()">Update Profile</ion-button>
        </div>
    </div>

    <!-- ADD CUSTOMER MODAL -->
    <div id="page-add-customer" class="fullscreen-modal hidden">
       <div class="ion-padding">
         <div style="display: flex; align-items: center; margin-bottom: 24px;">
           <ion-icon name="arrow-back" style="font-size: 24px; margin-right: 10px;" onclick="closeModal('page-add-customer')"></ion-icon>
           <h2 class="font-bold text-lg">Add Customer</h2>
         </div>
         <div class="app-card">
            <label class="text-xs font-bold text-gray">Full Name</label>
            <div class="custom-input"><input type="text" id="cust-name" placeholder="John Doe"></div>
            
            <label class="text-xs font-bold text-gray">Phone Number</label>
            <div class="custom-input"><input type="tel" id="cust-phone" placeholder="080..."></div>
            
            <div style="height: 1px; background: var(--border-color); margin: 16px 0;"></div>
            
            <label class="text-xs font-bold text-danger">Amount Owing (Optional)</label>
            <div class="custom-input"><input type="number" id="cust-debt" placeholder="0.00"></div>
         </div>
         <ion-button expand="block" class="btn-gold" onclick="saveCustomer()">Save Customer</ion-button>
       </div>
    </div>
    
    <!-- STAFF MANAGEMENT PAGE -->
    <div id="page-staff" class="fullscreen-modal hidden">
        <div class="ion-padding">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
               <div style="display: flex; align-items: center;">
                   <ion-icon name="arrow-back" style="font-size: 24px; margin-right: 10px;" onclick="closeModal('page-staff')"></ion-icon>
                   <h2 class="font-bold text-lg">Staff</h2>
               </div>
               <ion-button size="small" fill="outline" onclick="openModal('page-add-staff')">Add Staff</ion-button>
            </div>
            <div class="app-card" id="staff-list">
                <!-- Populated by JS -->
            </div>
            <div style="margin-top: 20px;">
                <ion-button expand="block" fill="clear" onclick="showToast('Role Management coming soon')">Manage Roles</ion-button>
            </div>
        </div>
    </div>

    <!-- ADD STAFF MODAL -->
    <div id="page-add-staff" class="popup-modal hidden">
        <div class="popup-content">
             <h3 class="font-bold text-lg" style="margin-bottom: 16px;">New Staff</h3>
             <label class="text-xs font-bold text-gray">Name</label>
             <div class="custom-input"><input type="text" id="staff-name-input"></div>
             <label class="text-xs font-bold text-gray">Role</label>
             <div class="custom-input">
                 <select id="staff-role-input">
                     <option value="Sales Rep">Sales Rep</option>
                     <option value="Manager">Manager</option>
                     <option value="Stock Keeper">Stock Keeper</option>
                 </select>
             </div>
             <ion-button expand="block" class="btn-gold" onclick="saveNewStaff()">Add Staff</ion-button>
             <ion-button expand="block" fill="clear" color="medium" onclick="closeModal('page-add-staff')">Cancel</ion-button>
        </div>
    </div>
    
    <!-- STAFF DETAILS MODAL -->
    <div id="page-staff-details" class="popup-modal hidden">
        <div class="popup-content" style="text-align:center;">
             <div style="width: 60px; height: 60px; background: #e5e7eb; border-radius: 50%; margin: 0 auto 10px auto; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:20px;" id="staff-detail-initial">?</div>
             <h3 class="font-bold text-lg" id="staff-detail-name">Staff Name</h3>
             <p class="text-gray text-sm" id="staff-detail-role" style="margin-bottom: 20px;">Role</p>
             
             <ion-button expand="block" color="danger" fill="outline" onclick="deleteStaff()">Remove Staff</ion-button>
             <ion-button expand="block" fill="clear" color="medium" onclick="closeModal('page-staff-details')">Close</ion-button>
        </div>
    </div>

  </ion-app>

  <!-- ================== LOGIC ================== -->
  <script>
    // --- STATE ---
    let state = {
        categories: ['Foodstuff', 'Beverages', 'Household', 'Toiletries'],
        inventory: [
            { sku: 'RC1', name: 'Rice (50kg)', cat: 'Foodstuff', price: 90000, stock: 12 },
            { sku: 'BV2', name: 'Milo Refill', cat: 'Beverages', price: 2500, stock: 45 },
            { sku: 'HH3', name: 'Dish Soap', cat: 'Household', price: 800, stock: 20 },
            { sku: 'FD4', name: 'Semovita', cat: 'Foodstuff', price: 6000, stock: 5 },
            { sku: 'BV5', name: 'Malta Guinness', cat: 'Beverages', price: 400, stock: 5 }, // For Insight
            { sku: 'TL6', name: 'Tissue Paper', cat: 'Toiletries', price: 500, stock: 100 },
        ],
        customers: [
            { id: 1, name: 'John James', phone: '08122789967', balance: 12500, totalSpent: 150000, history: [{desc: 'Rice (50kg)', date: '28/11/2024', amount: 90000}] },
            { id: 2, name: 'Mama Chika', phone: '08122789968', balance: 0, totalSpent: 45000, history: [] },
            { id: 3, name: 'Adewale Stores', phone: '08033221100', balance: 32500, totalSpent: 210000, history: [] }
        ],
        staff: [
            { id: 1, name: 'Joy B.', role: 'Sales Rep' },
            { id: 2, name: 'Emmanuel K.', role: 'Stock Keeper' }
        ],
        shopProfile: {
            name: 'Oreoluwa Store',
            phone: '08012345678',
            address: '12 Market Road, Lagos'
        },
        cart: [],
        activityLog: [
            { title: 'Sale', desc: 'Pepsi Cola (10)', time: '10:30 AM', icon: 'wallet' },
            { title: 'Restock', desc: 'Milo Refill (+20)', time: '09:15 AM', icon: 'cube' }
        ],
        todayTotal: 120000,
        salesHistory: [
            { time: '10:30 AM', desc: 'Pepsi Cola (10)', amount: 3000 },
            { time: '09:00 AM', desc: 'Rice (1)', amount: 90000 },
            { time: '08:45 AM', desc: 'Semovita (2)', amount: 12000 }
        ],
        currentCatFilter: 'All',
        currentCustFilter: 'all',
        tempQtySku: null,
        tempStaffId: null,
        tempProdSku: null,
        tempCustId: null
    };

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        setupNetworkListeners();
        renderCharts();
        renderInventoryList();
        renderCategories();
        renderRecentActivity();
        renderCustomerList();
        renderTopCustomers();
        updateDashboardTotals();
        renderStaffList();
        
        // Theme Listener
        const toggle = document.getElementById('theme-toggle');
        if(toggle) {
            toggle.addEventListener('ionChange', toggleTheme);
        }
        
        // Home Insight
        updateInsight('home');
    });

    // --- NAVIGATION ---
    function navigateTo(pageId) {
        document.querySelectorAll('.page-container').forEach(el => el.classList.add('hidden'));
        document.getElementById(pageId).classList.remove('hidden');
        if(pageId === 'page-dashboard') switchTab('home');
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById('tab-' + tabName).classList.remove('hidden');
        
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('btn-' + tabName).classList.add('active');

        // Logic refresh per tab
        if(tabName === 'inventory') {
            renderInventoryList();
            renderCategories(); // Ensure filter tabs are up to date
        }
        if(tabName === 'customers') { renderCustomerList(); renderTopCustomers(); }
        
        updateInsight(tabName);
    }
    
    function updateInsight(tab) {
        const textEl = document.getElementById('home-insight-text');
        const btnEl = document.getElementById('home-insight-btn');
        
        if(tab === 'home') {
            // Logic: Check lowest stock item
            const lowItem = state.inventory.sort((a,b) => a.stock - b.stock)[0];
            if(lowItem) {
                textEl.innerText = `"${lowItem.name}" is running low (${lowItem.stock} left). Customers might ask for it soon.`;
                btnEl.innerText = "Restock Now";
                btnEl.onclick = () => switchTab('inventory');
            }
        }
    }

    function openModal(id) { 
        document.getElementById(id).classList.remove('hidden'); 
        if(id === 'page-todays-sales') renderTodaysSales();
        if(id === 'page-activity-all') renderAllActivity();
        if(id === 'page-pos-add-item') renderPosAddList();
        if(id === 'page-add-product') populateCategorySelect();
    }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

    // --- THEME TOGGLE (FIXED) ---
    function toggleTheme() {
        document.body.classList.toggle('dark');
    }

    // --- CHARTS ---
    function renderCharts() {
        // MARKET REACH
        const labels = ['Jul', 'Aug', 'Sep', 'Oct', 'Nov'];
        const data = [704500, 850000, 920000, 1100000, 1275960];
        const maxVal = 1400000;
        
        let barSvg = `<svg class="svg-chart" viewBox="0 0 320 180">`;
        [0, 0.25, 0.5, 0.75, 1].forEach((pct, i) => {
            const y = 160 - (160 * pct);
            const labelVal = (pct * maxVal / 1000).toFixed(0) + 'k';
            barSvg += `<line x1="30" y1="${y}" x2="320" y2="${y}" class="chart-grid-line" />`;
            barSvg += `<text x="25" y="${y+3}" text-anchor="end" class="chart-axis-text">${labelVal}</text>`;
        });

        const barW = 30;
        const gap = (290 - (data.length * barW)) / (data.length + 1);
        data.forEach((val, i) => {
            const h = (val / maxVal) * 160;
            const x = 30 + gap + (i * (barW + gap));
            const y = 160 - h;
            barSvg += `<rect x="${x}" y="${y}" width="${barW}" height="${h}" class="chart-bar" />`;
            barSvg += `<text x="${x + barW/2}" y="175" text-anchor="middle" class="chart-axis-text">${labels[i]}</text>`;
            if(i === 4) { 
                 barSvg += `<text x="${x + barW/2}" y="${y - 5}" text-anchor="middle" font-size="9" font-weight="bold" fill="var(--ion-color-primary)">1.2M</text>`;
            }
        });
        barSvg += `</svg>`;
        document.getElementById('bar-chart-container').innerHTML = barSvg;

        // CUSTOMER RETENTION
        const retention = [60, 65, 70, 72, 80]; // Returning
        const newCust = [20, 40, 35, 50, 65];   // New
        
        let lineSvg = `<svg class="svg-chart" viewBox="0 0 320 150">`;
        lineSvg += `<circle cx="40" cy="10" r="4" fill="#10B981" /><text x="50" y="13" font-size="10" fill="var(--text-muted)">Loyal Customer</text>`;
        lineSvg += `<circle cx="120" cy="10" r="4" fill="var(--ion-color-primary)" /><text x="130" y="13" font-size="10" fill="var(--text-muted)">New Customer</text>`;

        const drawLine = (dataset, color) => {
            let d = "";
            dataset.forEach((val, i) => {
                const x = 30 + (i * 70);
                const y = 140 - val;
                d += (i===0 ? `M${x},${y}` : ` L${x},${y}`);
                lineSvg += `<circle cx="${x}" cy="${y}" r="3" fill="${color}" />`;
            });
            return `<path d="${d}" stroke="${color}" stroke-width="2" fill="none" />`;
        };

        lineSvg += drawLine(retention, '#10B981');
        lineSvg += drawLine(newCust, 'var(--ion-color-primary)');
        
        labels.forEach((l, i) => {
             lineSvg += `<text x="${30 + (i*70)}" y="150" text-anchor="middle" class="chart-axis-text">${l}</text>`;
        });

        lineSvg += `</svg>`;
        document.getElementById('line-chart-container').innerHTML = lineSvg;
    }

    // --- CUSTOMERS ---
    function renderCustomerList() {
        const container = document.getElementById('customer-list-container');
        const filterText = document.getElementById('customer-search').value.toLowerCase();
        container.innerHTML = '';

        state.customers.forEach(cust => {
            const matchesSearch = cust.name.toLowerCase().includes(filterText) || cust.phone.includes(filterText);
            const matchesFilter = state.currentCustFilter === 'all' || (state.currentCustFilter === 'owing' && cust.balance > 0);

            if(matchesSearch && matchesFilter) {
                container.innerHTML += `
                    <div class="customer-card ion-activatable" onclick="openCustomerDetail(${cust.id})">
                        <ion-ripple-effect></ion-ripple-effect>
                        <div style="display:flex; align-items:center;">
                            <div style="width:40px; height:40px; background:var(--app-bg); border-radius:50%; display:flex; align-items:center; justify-content:center; margin-right:12px; font-weight:bold; color:var(--text-muted);">
                                ${cust.name.charAt(0)}
                            </div>
                            <div>
                                <div class="font-bold text-sm">${cust.name}</div>
                                <div class="text-xs text-gray">${cust.phone}</div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            ${cust.balance > 0 ? `<div class="debt-badge">Owe: ${formatCurrency(cust.balance)}</div>` : `<div class="text-xs text-success font-bold">Paid</div>`}
                        </div>
                    </div>`;
            }
        });
    }

    function renderTopCustomers() {
        const list = document.getElementById('top-customers-list');
        const listMonth = document.getElementById('top-customers-month-list');
        
        const top = [...state.customers].sort((a,b) => b.totalSpent - a.totalSpent).slice(0, 5);
        
        const renderItem = (c) => `
            <div class="top-customer-item ion-activatable" onclick="openCustomerDetail(${c.id})">
                <ion-ripple-effect></ion-ripple-effect>
                <div class="font-bold text-sm text-primary">${c.name}</div>
                <div class="text-xs text-gray" style="margin-top:4px;">${formatCurrency(c.totalSpent)}</div>
            </div>
        `;
        
        list.innerHTML = top.map(renderItem).join('');
        listMonth.innerHTML = top.slice(0,3).map(renderItem).join(''); // Mocking month same as all time for now
    }

    function filterCustomers(type) {
        state.currentCustFilter = type;
        document.getElementById('seg-all').style.background = type === 'all' ? 'var(--card-bg)' : 'transparent';
        document.getElementById('seg-all').style.boxShadow = type === 'all' ? 'var(--shadow-sm)' : 'none';
        
        document.getElementById('seg-owing').style.background = type === 'owing' ? 'var(--card-bg)' : 'transparent';
        document.getElementById('seg-owing').style.boxShadow = type === 'owing' ? 'var(--shadow-sm)' : 'none';
        
        renderCustomerList();
    }

    function saveCustomer() {
        const name = document.getElementById('cust-name').value;
        const phone = document.getElementById('cust-phone').value;
        const debt = parseFloat(document.getElementById('cust-debt').value) || 0;
        
        if(name) {
            state.customers.push({ 
                id: Date.now(), 
                name, 
                phone, 
                balance: debt,
                totalSpent: 0,
                history: []
            });
            renderCustomerList();
            renderTopCustomers();
            closeModal('page-add-customer');
            showToast('Customer Added!');
        }
    }

    function openCustomerDetail(id) {
        state.tempCustId = id;
        const cust = state.customers.find(c => c.id === id);
        if(cust) {
            document.getElementById('detail-cust-name').innerText = cust.name;
            document.getElementById('detail-cust-initial').innerText = cust.name.charAt(0);
            document.getElementById('detail-cust-phone').innerText = cust.phone;
            document.getElementById('detail-cust-balance').innerText = formatCurrency(cust.balance);
            document.getElementById('detail-cust-spent').innerText = formatCurrency(cust.totalSpent);
            
            const histContainer = document.getElementById('detail-cust-history');
            histContainer.innerHTML = '';
            
            if(cust.history && cust.history.length > 0) {
                 cust.history.forEach(h => {
                     histContainer.innerHTML += `
                        <div class="list-item">
                            <div>
                                <div class="font-bold">${h.desc}</div>
                                <div class="text-xs text-gray">${h.date}</div>
                            </div>
                            <div class="font-bold">â‚¦${h.amount.toLocaleString()}</div>
                        </div>
                     `;
                 });
            } else {
                histContainer.innerHTML = '<div class="text-gray text-xs text-center" style="padding: 20px;">No transaction history yet.</div>';
            }
            openModal('page-customer-details');
        }
    }
    
    function deleteCustomer() {
        if(confirm("Are you sure you want to delete this customer? This cannot be undone.")) {
            state.customers = state.customers.filter(c => c.id !== state.tempCustId);
            renderCustomerList();
            renderTopCustomers();
            closeModal('page-customer-details');
            showToast("Customer Deleted");
        }
    }
    
    function confirmDebtPayment() {
        const amt = parseFloat(document.getElementById('debt-payment-amount').value);
        const cust = state.customers.find(c => c.id === state.tempCustId);
        
        if(cust && amt > 0) {
            cust.balance -= amt;
            if(cust.balance < 0) cust.balance = 0;
            
            cust.history.unshift({
                desc: 'Debt Payment',
                date: new Date().toLocaleDateString(),
                amount: amt
            });
            
            showToast(`Payment Recorded. New Balance: ${formatCurrency(cust.balance)}`);
            closeModal('page-record-payment');
            openCustomerDetail(state.tempCustId); // Refresh details
            renderCustomerList();
        }
    }
    
    function shareReminder() {
        const cust = state.customers.find(c => c.id === state.tempCustId);
        const date = document.getElementById('reminder-date').value;
        if(cust && date) {
            const msg = `Hello ${cust.name}, kindly pay your debt of ${formatCurrency(cust.balance)} to ${state.shopProfile.name} by ${date}. Thanks.`;
            const url = `https://wa.me/${cust.phone}?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
            closeModal('page-generate-reminder');
        } else {
            showToast('Please select a date');
        }
    }

    // --- STOCK & CATEGORIES ---
    function renderCategories() {
        const container = document.getElementById('inventory-category-tabs');
        container.innerHTML = `<div class="stock-tab ${state.currentCatFilter === 'All' ? 'active' : ''}" onclick="filterStock('All', this)">All</div>`;
        state.categories.forEach(cat => {
            container.innerHTML += `<div class="stock-tab ${state.currentCatFilter === cat ? 'active' : ''}" onclick="filterStock('${cat}', this)">${cat}</div>`;
        });
    }

    function filterStock(cat, element) {
        state.currentCatFilter = cat;
        // Visual updates
        document.querySelectorAll('.stock-tab').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        renderInventoryList();
    }

    function renderInventoryList() {
        const container = document.getElementById('inventory-list');
        const filter = document.getElementById('inventory-search').value.toLowerCase();
        container.innerHTML = '';

        state.inventory.forEach(item => {
            const matchesCat = state.currentCatFilter === 'All' || item.cat === state.currentCatFilter;
            const matchesSearch = item.name.toLowerCase().includes(filter);

            if(matchesCat && matchesSearch) {
                container.innerHTML += `
                    <div class="app-card ion-activatable" style="display: flex; justify-content: space-between; align-items: center;" onclick="openProductDetail('${item.sku}')">
                        <ion-ripple-effect></ion-ripple-effect>
                        <div>
                            <div class="font-bold">${item.name}</div>
                            <div class="text-xs text-gray">${item.cat} â€¢ SKU: ${item.sku}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="font-bold">${formatCurrency(item.price)}</div>
                            <div class="text-xs" style="color: ${item.stock < 10 ? 'red' : 'green'}">${item.stock} left</div>
                        </div>
                    </div>`;
            }
        });
    }
    
    function openProductDetail(sku) {
        state.tempProdSku = sku;
        const item = state.inventory.find(i => i.sku === sku);
        if(item) {
            document.getElementById('edit-prod-title').innerText = item.name;
            document.getElementById('edit-prod-sku').innerText = `SKU: ${item.sku}`;
            document.getElementById('edit-prod-stock').value = item.stock;
            document.getElementById('edit-prod-price').value = item.price;
            openModal('page-product-details');
        }
    }
    
    function restockProduct() {
        const amt = prompt("How many items are you adding?");
        if(amt && parseInt(amt) > 0) {
            const item = state.inventory.find(i => i.sku === state.tempProdSku);
            if(item) {
                item.stock += parseInt(amt);
                document.getElementById('edit-prod-stock').value = item.stock;
                showToast("Stock Updated");
                renderInventoryList();
            }
        }
    }
    
    function saveProductEdits() {
        const newPrice = document.getElementById('edit-prod-price').value;
        const item = state.inventory.find(i => i.sku === state.tempProdSku);
        if(item && newPrice) {
            item.price = parseFloat(newPrice);
            renderInventoryList();
            showToast("Product Updated");
            closeModal('page-product-details');
        }
    }
    
    function deleteProduct() {
        if(confirm("Delete this product?")) {
            state.inventory = state.inventory.filter(i => i.sku !== state.tempProdSku);
            renderInventoryList();
            closeModal('page-product-details');
            showToast("Product Deleted");
        }
    }
    
    function populateCategorySelect() {
        const sel = document.getElementById('add-prod-category');
        sel.innerHTML = '';
        state.categories.forEach(c => {
            sel.innerHTML += `<option value="${c}">${c}</option>`;
        });
    }
    
    function promptAddCategory() {
        const newCat = prompt("Enter New Category Name:");
        if(newCat) {
             state.categories.push(newCat);
             populateCategorySelect(); // Update modal select
             // Select the new one immediately
             document.getElementById('add-prod-category').value = newCat;
             
             // Update tabs immediately too
             renderCategories();
             
             showToast(`Category "${newCat}" created!`);
        }
    }
    
    function saveNewProduct() {
        const name = document.getElementById('add-prod-name').value;
        const price = parseInt(document.getElementById('add-prod-price').value);
        const stock = parseInt(document.getElementById('add-prod-stock').value);
        const cat = document.getElementById('add-prod-category').value;
        
        if(name && price) {
            state.inventory.push({
                sku: 'GEN' + Math.floor(Math.random()*1000),
                name: name,
                cat: cat,
                price: price,
                stock: stock || 0
            });
            renderInventoryList();
            showToast('Product Saved!');
            closeModal('page-add-product');
            // Clear inputs
            document.getElementById('add-prod-name').value = '';
            document.getElementById('add-prod-price').value = '';
        }
    }

    // --- POS ADD ITEM LOGIC (Fixed) ---
    function renderPosAddList() {
        const container = document.getElementById('pos-add-list');
        const filter = document.getElementById('pos-filter-input') ? document.getElementById('pos-filter-input').value.toLowerCase() : "";
        container.innerHTML = '';
        
        state.inventory.forEach(item => {
            if(item.name.toLowerCase().includes(filter)) {
                container.innerHTML += `
                    <div class="list-item ion-activatable" onclick="initiateAddToCart('${item.sku}')">
                        <ion-ripple-effect></ion-ripple-effect>
                        <div>
                            <div class="font-bold">${item.name}</div>
                            <div class="text-xs text-gray">Stock: ${item.stock}</div>
                        </div>
                        <ion-icon name="add-circle" style="font-size: 28px; color: var(--ion-color-secondary);"></ion-icon>
                    </div>`;
            }
        });
    }

    function initiateAddToCart(sku) {
        const item = state.inventory.find(i => i.sku === sku);
        if(!item) return;
        
        state.tempQtySku = sku;
        document.getElementById('qty-item-name').innerText = item.name;
        document.getElementById('qty-stock-display').innerText = `Available: ${item.stock}`;
        document.getElementById('qty-input').value = 1;
        
        closeModal('page-pos-add-item');
        openModal('page-pos-qty');
    }
    
    function adjustQty(amount) {
        const input = document.getElementById('qty-input');
        let val = parseInt(input.value) + amount;
        if(val < 1) val = 1;
        input.value = val;
    }

    function confirmAddToCart() {
        const sku = state.tempQtySku;
        const qty = parseInt(document.getElementById('qty-input').value);
        const item = state.inventory.find(i => i.sku === sku);
        
        if(item) {
            const existing = state.cart.find(c => c.sku === sku);
            if(existing) existing.qty += qty;
            else state.cart.push({...item, qty: qty});
            
            updateCartUI();
            closeModal('page-pos-qty');
            showToast('Item Added');
        }
    }

    function updateCartUI() {
        const container = document.getElementById('pos-items-list');
        let total = 0;
        container.innerHTML = '';
        
        if(state.cart.length > 0) {
            document.getElementById('pos-empty').classList.add('hidden');
            document.getElementById('pos-active').classList.remove('hidden');
            
            state.cart.forEach(item => {
                total += item.price * item.qty;
                container.innerHTML += `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <div>${item.name} <span class="text-muted">x${item.qty}</span></div>
                        <div class="font-bold">${formatCurrency(item.price * item.qty)}</div>
                    </div>`;
            });
            document.getElementById('pos-total').innerText = formatCurrency(total);
        }
    }
    
    function openInvoicePreview() {
        if(state.cart.length === 0) return;
        
        // Populate Invoice Data from Shop Profile
        document.getElementById('inv-shop-name').innerText = state.shopProfile.name;
        document.getElementById('inv-shop-address').innerText = state.shopProfile.address;
        document.getElementById('inv-shop-phone').innerText = state.shopProfile.phone;
        
        document.getElementById('inv-date').innerText = new Date().toLocaleDateString();
        document.getElementById('inv-time').innerText = new Date().toLocaleTimeString();
        
        const cont = document.getElementById('inv-items');
        cont.innerHTML = '';
        let total = 0;
        
        state.cart.forEach(item => {
            total += item.price * item.qty;
            cont.innerHTML += `
                <div class="invoice-row">
                    <span>${item.qty} x ${item.name}</span>
                    <span>${(item.price * item.qty).toLocaleString()}</span>
                </div>
            `;
        });
        document.getElementById('inv-total').innerText = formatCurrency(total);
        
        openModal('page-invoice-preview');
    }

    function finalizeSale() {
        let saleTotal = 0;
        let desc = "";
        
        state.cart.forEach((c, i) => {
            saleTotal += c.price * c.qty;
            if(i===0) desc = `${c.name} (${c.qty})`;
            // Deduct stock logic (simplified)
            const invItem = state.inventory.find(inv => inv.sku === c.sku);
            if(invItem) invItem.stock -= c.qty;
        });
        
        if(state.cart.length > 1) desc += ` + ${state.cart.length -1} others`;

        // Update State
        state.todayTotal += saleTotal;
        state.salesHistory.unshift({
            time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
            desc: desc,
            amount: saleTotal
        });
        
        state.activityLog.unshift({
            title: 'Sale', desc: desc, time: 'Just Now', icon: 'wallet'
        });

        updateDashboardTotals();
        renderRecentActivity();
        renderInventoryList(); // Refresh stock counts
        
        // Reset Cart
        state.cart = [];
        document.getElementById('pos-items-list').innerHTML = '';
        document.getElementById('pos-active').classList.add('hidden');
        document.getElementById('pos-empty').classList.remove('hidden');
        
        closeModal('page-invoice-preview');
        showToast('Sale Confirmed!');
        switchTab('home');
    }

    // --- ACTIVITY ---
    function renderRecentActivity() {
        const container = document.getElementById('recent-activity-list');
        container.innerHTML = '';
        state.activityLog.slice(0, 3).forEach(act => {
            container.innerHTML += createActivityHTML(act);
        });
    }
    
    function renderAllActivity() {
        const container = document.getElementById('all-activity-list-content');
        container.innerHTML = '';
        state.activityLog.forEach(act => {
            container.innerHTML += `<div class="app-card" style="padding: 12px; margin-bottom: 8px;">${createActivityHTML(act)}</div>`;
        });
    }
    
    function renderTodaysSales() {
        const container = document.getElementById('todays-sales-list');
        container.innerHTML = '';
        state.salesHistory.forEach(sale => {
            container.innerHTML += `
                <div class="list-item">
                    <div>
                        <div class="font-bold text-sm">${sale.desc}</div>
                        <div class="text-xs text-gray">${sale.time}</div>
                    </div>
                    <div class="font-bold text-success">+${formatCurrency(sale.amount)}</div>
                </div>
            `;
        });
        document.getElementById('modal-sales-total').innerText = formatCurrency(state.todayTotal);
    }

    function createActivityHTML(act) {
        return `
            <div style="padding: 12px 16px; display: flex; align-items: center; border-bottom: 1px solid var(--border-color);">
                <div style="width: 36px; height: 36px; background: var(--app-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                   <ion-icon name="${act.icon}" style="color: var(--text-muted); font-size: 18px;"></ion-icon>
                </div>
                <div style="flex: 1;">
                   <div class="font-bold text-sm">${act.title}</div>
                   <div class="text-xs text-gray">${act.desc}</div>
                </div>
                <div class="text-xs text-gray">${act.time}</div>
            </div>`;
    }

    // --- STAFF ---
    function renderStaffList() {
        const container = document.getElementById('staff-list');
        container.innerHTML = '';
        state.staff.forEach(s => {
            container.innerHTML += `
                <div class="list-item ion-activatable" onclick="openStaffDetail(${s.id})">
                    <ion-ripple-effect></ion-ripple-effect>
                    <div>
                        <div class="font-bold">${s.name}</div>
                        <div class="text-xs text-gray">${s.role}</div>
                    </div>
                    <ion-badge color="success">Active</ion-badge>
                </div>
            `;
        });
    }
    
    function openStaffDetail(id) {
        state.tempStaffId = id;
        const staff = state.staff.find(s => s.id === id);
        if(staff) {
            document.getElementById('staff-detail-name').innerText = staff.name;
            document.getElementById('staff-detail-initial').innerText = staff.name.charAt(0);
            document.getElementById('staff-detail-role').innerText = staff.role;
            openModal('page-staff-details');
        }
    }
    
    function saveNewStaff() {
        const name = document.getElementById('staff-name-input').value;
        const role = document.getElementById('staff-role-input').value;
        if(name) {
            state.staff.push({ id: Date.now(), name, role });
            renderStaffList();
            showToast('Staff Added');
            closeModal('page-add-staff');
        }
    }
    
    function deleteStaff() {
        state.staff = state.staff.filter(s => s.id !== state.tempStaffId);
        renderStaffList();
        closeModal('page-staff-details');
        showToast('Staff Removed');
    }

    // --- SETTINGS / PROFILE ---
    function saveProfile() {
        state.shopProfile.name = document.getElementById('prof-name').value;
        state.shopProfile.phone = document.getElementById('prof-phone').value;
        state.shopProfile.address = document.getElementById('prof-addr').value;
        showToast("Profile Updated");
        closeModal('page-profile');
    }

    function updateDashboardTotals() {
        const els = document.querySelectorAll('#home-today-sales');
        els.forEach(el => el.innerText = formatCurrency(state.todayTotal));
    }

    // --- UTILS ---
    function formatCurrency(num) {
        return 'â‚¦' + num.toLocaleString();
    }

    async function showToast(msg) {
        const toast = document.createElement('ion-toast');
        toast.message = msg;
        toast.duration = 2000;
        toast.position = 'top';
        document.body.appendChild(toast);
        return toast.present();
    }

    function setupNetworkListeners() {
        const updateStatus = () => {
            const isOnline = navigator.onLine;
            const badge = document.getElementById('status-badge');
            const posIcon = document.getElementById('pos-status-icon');
            const banner = document.getElementById('offline-banner');
            
            if(badge) {
                badge.innerText = isOnline ? "Online" : "Offline";
                badge.style.background = isOnline ? "#D1FAE5" : "#FEE2E2";
                badge.style.color = isOnline ? "#065F46" : "#B91C1C";
            }
            if(posIcon) posIcon.style.color = isOnline ? "var(--ion-color-secondary)" : "var(--text-muted)";
            if(banner) banner.classList.toggle('hidden', isOnline);
        };
        window.addEventListener('online', updateStatus);
        window.addEventListener('offline', updateStatus);
    }
  </script>
</body>
</html>